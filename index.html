<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LondriPediaCash</title>
    <meta name="description" content="Aplikasi Pencatatan Keuangan Harian LondriPedia">
    <meta name="theme-color" content="#2563eb">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTG9uZHJpUGVkaWFDYXNoIiwic2hvcnRfbmFtZSI6IkxvbmRyaUNhc2giLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzI1NjNlYiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBMU1URWdOVEV5SWo0OGNtVmpkQ0I0UFNJeE1EWWlJSGs5SWpFd05pSWlJSGRwWkhSb1BTSXpNREFpSUdobGFXZG9kRDBpTXpBd0lpQm1hV3hzUFNJak1qVTJNMlZpSWk4K1BIUmxlSFFnZUQwaU1qVTJJaUI1UFNJeU5UWWlJSFJsZUhRdFlXNWphRzl5UFNKdGFXUmtiR1VpSUdacGJHeDlJaU5tWm1abVptWWlJR1p2Ym5RdGMybDZaVDBpTkRCd2VDSStNamN5TW1aaVBDOTBaWGgwUGp3dmMzWm5QZz09Iiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB4PSIxMDYiIHk9IjEwNiIgd2lkdGg9IjMwMCIgaGVpZ2h0PSIzMDAiIGZpbGw9IiMyNTYzZWIiLz48dGV4dCB4PSIyNTYiIHk9IjI1NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI2ZmZmZmZiIgZm9udC1zaXplPSI0MHB4Ij4yNzIyZmI8L3RleHQ+PC9zdmc+">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            line-height: 1.6;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        .online-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .online-status.offline {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .content {
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .readonly-input {
            background: #f8fafc;
            color: #6b7280;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            pointer-events: auto;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-full {
            width: 100%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #0284c7;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #0c4a6e;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #075985;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .transaction-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-amount {
            font-weight: bold;
            color: #059669;
        }

        .transaction-details {
            font-size: 12px;
            color: #6b7280;
        }

        .transaction-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-validated {
            background: #d1fae5;
            color: #065f46;
        }

        .status-transferred {
            background: #dbeafe;
            color: #1e40af;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #059669;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #dc2626;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #2563eb;
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-small {
            font-size: 12px;
            color: #6b7280;
        }

        .mt-2 {
            margin-top: 8px;
        }

        .mb-4 {
            margin-bottom: 16px;
        }

        .validation-section {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .validation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #fde68a;
        }

        .validation-item:last-child {
            border-bottom: none;
        }

        .validation-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .chart-placeholder {
            height: 200px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0369a1;
            font-weight: 500;
            border: 2px dashed #0284c7;
            text-align: center;
        }

        .install-prompt {
            background: #1e40af;
            color: white;
            padding: 12px 16px;
            text-align: center;
            font-size: 14px;
            position: relative;
        }

        .close-prompt {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
        }

        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s;
        }

        .sync-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #059669;
        }

        .sync-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #dc2626;
        }

        .sync-pending {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
            animation: pulse 1s infinite;
        }

        @media (max-width: 480px) {
            .content {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .sync-indicator {
                bottom: 10px;
                right: 10px;
            }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* PWA Install Animation */
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        .install-prompt {
            animation: slideDown 0.5s ease-out;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- PWA Install Prompt -->
        <div id="installPrompt" class="install-prompt hidden">
            üì± Install LondriPediaCash untuk akses lebih cepat!
            <button class="close-prompt" onclick="closeInstallPrompt()">√ó</button>
        </div>

        <!-- Sync Indicator -->
        <div id="syncIndicator" class="sync-indicator sync-success hidden">
            ‚òÅÔ∏è Tersinkronisasi
        </div>

        <!-- Login Screen -->
        <div id="loginScreen">
            <div class="header">
                <div id="onlineStatus" class="online-status">Online</div>
                <h1>üè™ LondriPediaCash</h1>
                <p class="subtitle">Pencatatan Keuangan Harian LondriPedia</p>
            </div>
            <div class="content">
                <div id="connectionAlert" class="alert alert-info">
                    ‚òÅÔ∏è <strong>Mode Online</strong> - Data tersimpan realtime di Google Sheets + backup lokal
                </div>
                
                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Masukkan Kode Akses</label>
                        <input type="password" id="accessCode" class="form-input" placeholder="Kode akses..." maxlength="5" autocomplete="off">
                    </div>
                    <button class="btn btn-primary btn-full" onclick="login()">
                        <span id="loginSpinner" class="loading hidden"></span>
                        MASUK
                    </button>
                    <div class="text-center text-small mt-2">
                        <span id="storageStatus">Aplikasi siap digunakan - data aman tersimpan</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SPV Interface -->
        <div id="spvScreen" class="hidden">
            <div class="header">
                <div id="spvOnlineStatus" class="online-status">Online</div>
                <h1>üìä Input Transaksi</h1>
                <p class="subtitle">SPV/Kasir - LondriPedia</p>
            </div>
            <div class="content">
                <div class="card">
                    <div class="form-group">
                        <label class="form-label">üìÖ Tanggal</label>
                        <input type="text" id="spvDate" class="form-input readonly-input" readonly>
                        <div class="text-small mt-2">
                            üïê Waktu: <span id="spvTime"></span> (otomatis)
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üí∞ Jumlah Uang Diterima <span style="color: #dc2626;">*</span></label>
                        <input type="text" id="spvAmount" class="form-input" placeholder="contoh: 150000 atau 150.000">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üìù Catatan (opsional)</label>
                        <input type="text" id="spvNote" class="form-input" placeholder="contoh: kas pagi" maxlength="100">
                    </div>
                    
                    <button class="btn btn-primary btn-full" onclick="submitTransaction()">
                        <span id="submitSpinner" class="loading hidden"></span>
                        üíæ SIMPAN KE GOOGLE SHEETS
                    </button>
                </div>

                <div id="successAlert" class="alert alert-success hidden">
                    ‚úÖ Data berhasil tersimpan ke Google Sheets! Menunggu validasi Owner
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 16px;">üìã Input Hari Ini (5 Terakhir)</h3>
                    <div id="todayTransactions" class="transaction-list">
                        <div class="text-center text-small" style="padding: 20px;">
                            Belum ada transaksi hari ini
                        </div>
                    </div>
                </div>

                <div class="text-center mt-2">
                    <button class="btn" style="background: #6b7280; color: white;" onclick="logout()">
                        ‚Üê Kembali ke Login
                    </button>
                </div>
            </div>
        </div>

        <!-- Owner Dashboard -->
        <div id="ownerScreen" class="hidden">
            <div class="header">
                <div id="ownerOnlineStatus" class="online-status">Online</div>
                <h1>üìä Owner Dashboard</h1>
                <p class="subtitle">LondriPediaCash - Monitoring Realtime</p>
            </div>
            <div class="content">
                <!-- Summary Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="todayTotal">Rp 0</div>
                        <div class="stat-label">Hari Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weekTotal">Rp 0</div>
                        <div class="stat-label">Minggu Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="monthTotal">Rp 0</div>
                        <div class="stat-label">Bulan Ini</div>
                    </div>
                </div>

                <!-- Pending Transfer Alert -->
                <div id="pendingAlert" class="alert alert-warning hidden">
                    ‚ö†Ô∏è <strong>BELUM DITRANSFER KE REKENING:</strong> 
                    <div style="margin-top: 8px;">
                        <span id="pendingAmount" style="font-size: 18px; font-weight: bold;">Rp 0</span> 
                        (<span id="pendingCount">0</span> transaksi)
                    </div>
                    <div style="margin-top: 12px;">
                        <button id="transferButton" class="btn btn-success" onclick="handleTransferAll()" style="pointer-events: auto; cursor: pointer;">
                            <span id="transferSpinner" class="loading hidden"></span>
                            üí∏ SUDAH DITRANSFER KE REKENING
                        </button>
                    </div>
                </div>

                <!-- Transfer History Summary -->
                <div id="transferHistorySummary" class="card">
                    <h3 style="margin-bottom: 16px; color: #059669;">üí∞ RIWAYAT TRANSFER KE REKENING</h3>
                    <div id="transferHistoryList" class="transaction-list" style="max-height: 200px;">
                        <div class="text-center text-small" style="padding: 20px;">
                            Belum ada riwayat transfer
                        </div>
                    </div>
                    <div style="margin-top: 12px; text-align: center;">
                        <button class="btn btn-small" style="background: #059669; color: white;" onclick="toggleTransferHistory()">
                            üìã <span id="transferHistoryToggle">Lihat Semua History</span>
                        </button>
                    </div>
                </div>

                <!-- Validation Section -->
                <div id="validationSection" class="validation-section hidden">
                    <h3 style="margin-bottom: 16px; color: #92400e;">‚úÖ VALIDASI TRANSAKSI</h3>
                    <div id="pendingTransactions"></div>
                </div>

                <!-- Charts Section -->
                <div class="card chart-section">
                    <h3 style="margin-bottom: 16px;">üìà Grafik & Laporan</h3>
                    <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                        <button class="btn btn-primary btn-small" onclick="showChart('daily')">Harian</button>
                        <button class="btn btn-small" style="background: #6b7280; color: white;" onclick="showChart('weekly')">Mingguan</button>
                        <button class="btn btn-small" style="background: #6b7280; color: white;" onclick="showChart('monthly')">Bulanan</button>
                        <button class="btn btn-small" style="background: #6b7280; color: white;" onclick="showChart('custom')">Custom</button>
                        <button class="btn btn-small" style="background: #059669; color: white;" onclick="refreshFromSheets()">üîÑ Refresh</button>
                    </div>
                    <div class="chart-placeholder">
                        üìä GRAFIK TREN PEMASUKAN HARIAN<br>
                        <small>(Data realtime dari Google Sheets)</small>
                    </div>
                </div>

                <!-- Monitoring Tabs -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>üìã Monitoring Transaksi</h3>
                    </div>
                    
                    <!-- Tab Navigation -->
                    <div style="display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap;">
                        <button id="tabPending" class="btn btn-primary btn-small" onclick="switchTab('pending')">
                            Pending Validasi (<span id="pendingValidationCount">0</span>)
                        </button>
                        <button id="tabNotTransferred" class="btn btn-small" style="background: #f59e0b; color: white;" onclick="switchTab('not-transferred')">
                            Belum Transfer (<span id="notTransferredCount">0</span>)
                        </button>
                        <button id="tabTransferred" class="btn btn-small" style="background: #059669; color: white;" onclick="switchTab('transferred')">
                            Sudah Transfer
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div id="tabContent" class="transaction-list" style="min-height: 200px;">
                        <!-- Content will be loaded dynamically -->
                    </div>
                </div>

                <div class="text-center mt-2">
                    <button class="btn" style="background: #6b7280; color: white;" onclick="logout()">
                        ‚Üê Kembali ke Login
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Google Sheets Integration
        const CONFIG = {
            GOOGLE_SHEETS_API_URL: 'https://script.google.com/macros/s/AKfycbxqswvcT65iV-17EbmwZ9BX4vYMaLDkGHf8uvT7lGFggl5Rwlxbaewh9E0xXaqAlubaIQ/exec',
            SYNC_ENABLED: true,
            API_TIMEOUT: 8000,
            VERSION: '1.0-Online'
        };

        // Enhanced DataStore with Google Sheets Integration
        class DataStore {
            constructor() {
                try {
                    this.transactions = JSON.parse(localStorage.getItem('londripedia_transactions') || '[]');
                    this.transferHistory = JSON.parse(localStorage.getItem('londripedia_transfers') || '[]');
                    this.lastId = parseInt(localStorage.getItem('londripedia_last_id') || '0');
                    this.storageAvailable = true;
                    this.isOnline = navigator.onLine;
                    
                    // Test Google Sheets connection
                    this.testConnection();
                } catch (error) {
                    console.log('Using memory storage (data will not persist)');
                    this.transactions = [];
                    this.transferHistory = [];
                    this.lastId = 0;
                    this.storageAvailable = false;
                    this.isOnline = false;
                }
            }

            async testConnection() {
                try {
                    const controller = new AbortController();
                    setTimeout(() => controller.abort(), CONFIG.API_TIMEOUT);
                    
                    const response = await fetch(CONFIG.GOOGLE_SHEETS_API_URL + '?action=health_check', {
                        method: 'GET',
                        signal: controller.signal
                    });
                    
                    if (response.ok) {
                        this.isOnline = true;
                        updateOnlineStatus(true);
                        console.log('‚úÖ Google Sheets connection established');
                    } else {
                        throw new Error('API not responding');
                    }
                } catch (error) {
                    this.isOnline = false;
                    updateOnlineStatus(false);
                    console.log('üì± Using offline mode:', error.message);
                }
            }

            async syncToGoogleSheets(action, data) {
                if (!this.isOnline || !CONFIG.SYNC_ENABLED) return null;
                
                try {
                    showSyncIndicator('pending');
                    
                    const controller = new AbortController();
                    setTimeout(() => controller.abort(), CONFIG.API_TIMEOUT);
                    
                    const response = await fetch(CONFIG.GOOGLE_SHEETS_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ action, ...data }),
                        signal: controller.signal
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    showSyncIndicator('success');
                    return result;
                    
                } catch (error) {
                    showSyncIndicator('error');
                    console.error('Sync error:', error);
                    return null;
                }
            }

            save() {
                if (this.storageAvailable) {
                    try {
                        localStorage.setItem('londripedia_transactions', JSON.stringify(this.transactions));
                        localStorage.setItem('londripedia_transfers', JSON.stringify(this.transferHistory));
                        localStorage.setItem('londripedia_last_id', this.lastId.toString());
                    } catch (error) {
                        console.log('Cannot save to localStorage, using memory only');
                    }
                }
            }

            async addTransaction(amount, note) {
                const now = new Date();
                const transaction = {
                    id: ++this.lastId,
                    timestamp: now.toISOString(),
                    date: now.toISOString().split('T')[0],
                    amount: amount,
                    note: note || '',
                    inputBy: 'SPV',
                    validated: false,
                    transferred: false,
                    transferDate: null
                };
                
                // Save locally first
                this.transactions.push(transaction);
                this.save();
                
                // Sync to Google Sheets
                if (this.isOnline) {
                    await this.syncToGoogleSheets('add_transaction', {
                        amount: amount,
                        note: note
                    });
                }
                
                return transaction;
            }

            async validateTransaction(id) {
                const transaction = this.transactions.find(t => t.id === id);
                if (transaction) {
                    transaction.validated = true;
                    this.save();
                    
                    // Sync to Google Sheets
                    if (this.isOnline) {
                        await this.syncToGoogleSheets('validate_transaction', { id });
                    }
                }
            }

            async deleteTransaction(id) {
                const index = this.transactions.findIndex(t => t.id === id);
                if (index !== -1) {
                    this.transactions.splice(index, 1);
                    this.save();
                    
                    // Sync to Google Sheets
                    if (this.isOnline) {
                        await this.syncToGoogleSheets('delete_transaction', { id });
                    }
                }
            }

            async transferAll() {
                const pendingTransactions = this.transactions.filter(t => t.validated && !t.transferred);
                if (pendingTransactions.length === 0) return null;

                const now = new Date();
                const transferRecord = {
                    id: this.transferHistory.length + 1,
                    date: now.toISOString().split('T')[0],
                    count: pendingTransactions.length,
                    total: pendingTransactions.reduce((sum, t) => sum + t.amount, 0),
                    periodFrom: pendingTransactions[0].date,
                    periodTo: pendingTransactions[pendingTransactions.length - 1].date,
                    note: 'Transfer ke rekening'
                };

                // Mark ALL pending transactions as transferred
                pendingTransactions.forEach(t => {
                    t.transferred = true;
                    t.transferDate = now.toISOString().split('T')[0];
                });

                this.transferHistory.push(transferRecord);
                this.save();
                
                // Sync to Google Sheets
                if (this.isOnline) {
                    await this.syncToGoogleSheets('transfer_all', {});
                }
                
                console.log('Transfer completed:', transferRecord);
                return transferRecord;
            }

            async getStatsFromSheets() {
                if (!this.isOnline) return this.getStats();
                
                try {
                    const result = await this.syncToGoogleSheets('get_stats', {});
                    return result || this.getStats();
                } catch (error) {
                    return this.getStats();
                }
            }

            getStats() {
                const today = new Date().toISOString().split('T')[0];
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

                const validatedTransactions = this.transactions.filter(t => t.validated);

                return {
                    today: validatedTransactions.filter(t => t.date === today).reduce((sum, t) => sum + t.amount, 0),
                    week: validatedTransactions.filter(t => t.date >= weekAgo).reduce((sum, t) => sum + t.amount, 0),
                    month: validatedTransactions.filter(t => t.date >= monthAgo).reduce((sum, t) => sum + t.amount, 0),
                    pending: this.transactions.filter(t => t.validated && !t.transferred).reduce((sum, t) => sum + t.amount, 0),
                    pendingCount: this.transactions.filter(t => t.validated && !t.transferred).length,
                    unvalidatedCount: this.transactions.filter(t => !t.validated).length
                };
            }

            getTodayTransactions() {
                const today = new Date().toISOString().split('T')[0];
                return this.transactions.filter(t => t.date === today).slice(-5);
            }

            getPendingValidation() {
                return this.transactions.filter(t => !t.validated);
            }

            getAllTransactions() {
                return [...this.transactions].reverse();
            }
        }

        // Global variables - ORIGINAL STRUCTURE
        let dataStore = new DataStore();
        let currentView = 'login';
        let currentTab = 'pending';
        let showFullTransferHistory = false;

        // Utility functions - ORIGINAL
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatTime() {
            return new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDate() {
            return new Date().toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
        }

        function showScreen(screenId) {
            document.querySelectorAll('#loginScreen, #spvScreen, #ownerScreen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            currentView = screenId.replace('Screen', '');
        }

        function showAlert(message, type = 'success', duration = 3000) {
            const alertElement = document.getElementById('successAlert');
            alertElement.className = `alert alert-${type}`;
            alertElement.innerHTML = message;
            alertElement.classList.remove('hidden');
            
            setTimeout(() => {
                alertElement.classList.add('hidden');
            }, duration);
        }

        // NEW: Online Status & Sync Functions
        function updateOnlineStatus(isOnline) {
            const statusElements = document.querySelectorAll('[id$="OnlineStatus"], #onlineStatus');
            const connectionAlert = document.getElementById('connectionAlert');
            
            statusElements.forEach(element => {
                element.className = isOnline ? 'online-status' : 'online-status offline';
                element.textContent = isOnline ? 'Online' : 'Offline';
            });
            
            if (connectionAlert) {
                if (isOnline) {
                    connectionAlert.className = 'alert alert-info';
                    connectionAlert.innerHTML = '‚òÅÔ∏è <strong>Mode Online</strong> - Data tersimpan realtime di Google Sheets + backup lokal';
                } else {
                    connectionAlert.className = 'alert alert-warning';
                    connectionAlert.innerHTML = 'üì± <strong>Mode Offline</strong> - Data tersimpan lokal, akan disinkronkan saat online';
                }
            }
        }

        function showSyncIndicator(status) {
            const indicator = document.getElementById('syncIndicator');
            if (!indicator) return;
            
            indicator.className = `sync-indicator sync-${status}`;
            
            switch(status) {
                case 'success':
                    indicator.innerHTML = '‚òÅÔ∏è Tersinkronisasi';
                    indicator.classList.remove('hidden');
                    setTimeout(() => indicator.classList.add('hidden'), 3000);
                    break;
                case 'error':
                    indicator.innerHTML = '‚ùå Error sync';
                    indicator.classList.remove('hidden');
                    setTimeout(() => indicator.classList.add('hidden'), 5000);
                    break;
                case 'pending':
                    indicator.innerHTML = '‚è≥ Menyinkronkan...';
                    indicator.classList.remove('hidden');
                    break;
            }
        }

        // Login functionality - ORIGINAL
        function login() {
            const code = document.getElementById('accessCode').value.trim();
            const spinner = document.getElementById('loginSpinner');
            
            if (!code) {
                showAlert('Masukkan kode akses!', 'danger');
                return;
            }

            spinner.classList.remove('hidden');
            
            setTimeout(() => {
                spinner.classList.add('hidden');
                
                if (code === '1') {
                    try {
                        initSPVScreen();
                        showScreen('spvScreen');
                        showAlert('‚úÖ Login berhasil sebagai SPV!', 'success');
                    } catch (error) {
                        showAlert('Error loading SPV screen', 'danger');
                    }
                } else if (code === '08625') {
                    try {
                        initOwnerScreen();
                        showScreen('ownerScreen');
                        showAlert('‚úÖ Login berhasil sebagai Owner!', 'success');
                    } catch (error) {
                        showAlert('Error loading Owner screen', 'danger');
                        showScreen('ownerScreen');
                        document.getElementById('todayTotal').textContent = 'Rp 0';
                        document.getElementById('weekTotal').textContent = 'Rp 0';
                        document.getElementById('monthTotal').textContent = 'Rp 0';
                    }
                } else {
                    showAlert('Kode akses tidak valid!', 'danger');
                }
                
                document.getElementById('accessCode').value = '';
            }, 1000);
        }

        function logout() {
            showScreen('loginScreen');
        }

        // SPV Screen functions - ORIGINAL + Sync
        function initSPVScreen() {
            document.getElementById('spvDate').value = formatDate();
            updateSPVTime();
            loadTodayTransactions();
            
            setInterval(updateSPVTime, 60000);
        }

        function updateSPVTime() {
            document.getElementById('spvTime').textContent = formatTime();
        }

        async function submitTransaction() {
            const amountInput = document.getElementById('spvAmount');
            const noteInput = document.getElementById('spvNote');
            const spinner = document.getElementById('submitSpinner');
            
            const amountText = amountInput.value.replace(/[^0-9]/g, '');
            const amount = parseInt(amountText);
            const note = noteInput.value.trim();

            if (!amount || amount <= 0) {
                showAlert('Jumlah uang wajib diisi dengan benar!', 'danger');
                return;
            }

            spinner.classList.remove('hidden');

            try {
                const transaction = await dataStore.addTransaction(amount, note);
                
                // Clear form
                amountInput.value = '';
                noteInput.value = '';
                
                // Show success
                const syncText = dataStore.isOnline ? 'tersimpan ke Google Sheets' : 'tersimpan lokal (akan disinkronkan)';
                showAlert(`‚úÖ Data berhasil ${syncText}! Menunggu validasi Owner`);
                
                // Reload today's transactions
                loadTodayTransactions();
                
            } catch (error) {
                showAlert('‚ùå Error menyimpan data: ' + error.message, 'danger');
            } finally {
                spinner.classList.add('hidden');
            }
        }

        function loadTodayTransactions() {
            const container = document.getElementById('todayTransactions');
            const transactions = dataStore.getTodayTransactions();
            
            if (transactions.length === 0) {
                container.innerHTML = '<div class="text-center text-small" style="padding: 20px;">Belum ada transaksi hari ini</div>';
                return;
            }

            container.innerHTML = transactions.map(t => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-amount">${formatCurrency(t.amount)}</div>
                        <div class="transaction-details">${new Date(t.timestamp).toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})} - ${t.note}</div>
                    </div>
                    <div class="transaction-status ${t.validated ? 'status-validated' : 'status-pending'}">
                        ${t.validated ? '‚úÖ Valid' : '‚è≥ Pending'}
                    </div>
                </div>
            `).join('');
        }

        // Owner Screen functions - ORIGINAL + Sync
        async function initOwnerScreen() {
            try {
                await updateOwnerStats();
                loadPendingValidation();
                
                currentTab = 'pending';
                switchTab('pending');
                
                // Auto-refresh from Google Sheets every 30 seconds
                setInterval(async () => {
                    if (currentView === 'owner') {
                        await updateOwnerStats();
                    }
                }, 30000);
                
            } catch (error) {
                console.error('Error in initOwnerScreen:', error);
                document.getElementById('todayTotal').textContent = 'Rp 0';
                document.getElementById('weekTotal').textContent = 'Rp 0';
                document.getElementById('monthTotal').textContent = 'Rp 0';
            }
        }

        async function updateOwnerStats() {
            try {
                const stats = dataStore.isOnline ? 
                    await dataStore.getStatsFromSheets() : 
                    dataStore.getStats();
                
                // Update summary cards
                document.getElementById('todayTotal').textContent = formatCurrency(stats.today);
                document.getElementById('weekTotal').textContent = formatCurrency(stats.week);
                document.getElementById('monthTotal').textContent = formatCurrency(stats.month);
                
                // Update pending alert
                const pendingAlert = document.getElementById('pendingAlert');
                
                if (stats.pending > 0) {
                    document.getElementById('pendingAmount').textContent = formatCurrency(stats.pending);
                    document.getElementById('pendingCount').textContent = stats.pendingCount;
                    pendingAlert.classList.remove('hidden');
                } else {
                    pendingAlert.classList.add('hidden');
                }
                
                // Update tab counters
                document.getElementById('pendingValidationCount').textContent = stats.unvalidatedCount;
                document.getElementById('notTransferredCount').textContent = stats.pendingCount;
                
                // Update validation section
                const validationSection = document.getElementById('validationSection');
                if (stats.unvalidatedCount > 0) {
                    validationSection.classList.remove('hidden');
                    loadPendingValidation();
                } else {
                    validationSection.classList.add('hidden');
                }
                
                loadTransferHistorySummary();
                
                if (currentTab) {
                    switchTab(currentTab);
                }
                
            } catch (error) {
                console.error('Error in updateOwnerStats:', error);
            }
        }

        function loadPendingValidation() {
            const container = document.getElementById('pendingTransactions');
            const pendingTransactions = dataStore.getPendingValidation();
            
            if (pendingTransactions.length === 0) {
                container.innerHTML = '<div class="text-center text-small" style="padding: 20px;">Tidak ada transaksi yang perlu divalidasi</div>';
                return;
            }

            container.innerHTML = pendingTransactions.map(t => `
                <div class="validation-item">
                    <div class="transaction-info">
                        <div class="transaction-amount">${formatCurrency(t.amount)}</div>
                        <div class="transaction-details">${new Date(t.timestamp).toLocaleString('id-ID')} - ${t.note}</div>
                    </div>
                    <div class="validation-buttons">
                        <button class="btn btn-success btn-small" onclick="validateTransaction(${t.id})">
                            ‚úì Validasi
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteTransaction(${t.id})">
                            ‚ùå Tolak
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function validateTransaction(id) {
            await dataStore.validateTransaction(id);
            showAlert('‚úÖ Transaksi berhasil divalidasi!');
            await updateOwnerStats();
        }

        async function deleteTransaction(id) {
            if (confirm('Yakin ingin menolak transaksi ini?')) {
                await dataStore.deleteTransaction(id);
                showAlert('‚ùå Transaksi berhasil ditolak!', 'warning');
                await updateOwnerStats();
            }
        }

        async function handleTransferAll() {
            try {
                const beforeTransfer = dataStore.transactions.filter(t => t.validated && !t.transferred);
                
                if (beforeTransfer.length === 0) {
                    showAlert('Tidak ada transaksi yang perlu ditransfer!', 'warning');
                    return;
                }

                const totalAmount = beforeTransfer.reduce((sum, t) => sum + t.amount, 0);
                const message = `Transfer ${beforeTransfer.length} transaksi ke rekening?\n\nTotal: ${formatCurrency(totalAmount)}`;
                
                if (confirm(message)) {
                    const transferButton = document.getElementById('transferButton');
                    const spinner = document.getElementById('transferSpinner');
                    
                    transferButton.disabled = true;
                    spinner.classList.remove('hidden');
                    
                    const transferRecord = await dataStore.transferAll();
                    
                    if (transferRecord) {
                        showAlert(`üí∏ ${transferRecord.count} transaksi berhasil ditransfer ke rekening!`, 'success');
                        await updateOwnerStats();
                    }
                    
                    transferButton.disabled = false;
                    spinner.classList.add('hidden');
                }
                
            } catch (error) {
                showAlert('‚ùå Error processing transfer: ' + error.message, 'danger');
            }
        }

        // ALL OTHER FUNCTIONS REMAIN EXACTLY THE SAME AS ORIGINAL

        function loadTransferHistorySummary() {
            const container = document.getElementById('transferHistoryList');
            const history = dataStore.transferHistory.slice(-3);
            
            if (history.length === 0) {
                container.innerHTML = '<div class="text-center text-small" style="padding: 20px;">Belum ada riwayat transfer</div>';
                return;
            }

            const displayHistory = showFullTransferHistory ? dataStore.transferHistory.slice().reverse() : history.slice().reverse();
            
            container.innerHTML = displayHistory.map((h, index) => `
                <div class="transaction-item" style="background: #d1fae5; border-left: 4px solid #059669;">
                    <div class="transaction-info">
                        <div class="transaction-amount" style="color: #065f46;">${formatCurrency(h.total)}</div>
                        <div class="transaction-details">
                            ${new Date(h.date).toLocaleDateString('id-ID')} - ${h.count} transaksi - ${h.note}
                        </div>
                        <div class="transaction-details" style="font-size: 11px; color: #059669;">
                            Transfer #${h.id} - ${h.periodFrom} sampai ${h.periodTo}
                        </div>
                    </div>
                    <div class="transaction-status" style="background: #d1fae5; color: #065f46; border: 1px solid #059669;">
                        ‚úÖ Selesai
                    </div>
                </div>
            `).join('');
        }

        function toggleTransferHistory() {
            showFullTransferHistory = !showFullTransferHistory;
            const toggle = document.getElementById('transferHistoryToggle');
            toggle.textContent = showFullTransferHistory ? 'Sembunyikan' : 'Lihat Semua History';
            loadTransferHistorySummary();
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            const tabs = {
                'tabPending': { name: 'pending', bg: '#dc2626' },
                'tabNotTransferred': { name: 'not-transferred', bg: '#f59e0b' },
                'tabTransferred': { name: 'transferred', bg: '#059669' }
            };
            
            Object.keys(tabs).forEach(tabId => {
                const btn = document.getElementById(tabId);
                if (btn) {
                    if (tabs[tabId].name === tabName) {
                        btn.style.background = tabs[tabId].bg;
                        btn.style.color = 'white';
                    } else {
                        btn.style.background = '#6b7280';
                        btn.style.color = 'white';
                    }
                }
            });

            const container = document.getElementById('tabContent');
            
            switch(tabName) {
                case 'pending':
                    loadTabPendingValidation(container);
                    break;
                case 'not-transferred':
                    loadTabNotTransferred(container);
                    break;
                case 'transferred':
                    loadTabTransferred(container);
                    break;
            }
        }

        function loadTabPendingValidation(container) {
            const pendingTransactions = dataStore.getPendingValidation();
            
            if (pendingTransactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-small" style="padding: 40px; color: #059669;">
                        ‚úÖ Tidak ada transaksi yang perlu divalidasi<br>
                        <small>Semua transaksi sudah divalidasi</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = pendingTransactions.map(t => `
                <div class="validation-item" style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="transaction-info">
                            <div class="transaction-amount" style="color: #92400e;">${formatCurrency(t.amount)}</div>
                            <div class="transaction-details" style="color: #92400e;">${new Date(t.timestamp).toLocaleString('id-ID')} - ${t.note || 'Tanpa catatan'}</div>
                        </div>
                        <div class="validation-buttons">
                            <button class="btn btn-success btn-small" onclick="validateTransaction(${t.id})">
                                ‚úì Validasi
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteTransaction(${t.id})">
                                ‚ùå Tolak
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadTabNotTransferred(container) {
            const notTransferred = dataStore.transactions.filter(t => t.validated && !t.transferred);
            
            if (notTransferred.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-small" style="padding: 40px; color: #059669;">
                        ‚úÖ Semua transaksi sudah ditransfer ke rekening<br>
                        <small>Tidak ada yang perlu ditransfer</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = notTransferred.reverse().map(t => `
                <div class="transaction-item" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
                    <div class="transaction-info">
                        <div class="transaction-amount" style="color: #92400e;">${formatCurrency(t.amount)}</div>
                        <div class="transaction-details">${new Date(t.timestamp).toLocaleString('id-ID')} - ${t.note || 'Tanpa catatan'}</div>
                    </div>
                    <div class="transaction-status" style="background: #fef3c7; color: #92400e; border: 1px solid #f59e0b;">
                        ‚è≥ Belum Transfer
                    </div>
                </div>
            `).join('');
        }

        function loadTabTransferred(container) {
            const transferred = dataStore.transactions.filter(t => t.transferred);
            
            if (transferred.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-small" style="padding: 40px; color: #6b7280;">
                        Belum ada transaksi yang ditransfer<br>
                        <small>History transfer akan muncul di sini</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = transferred.reverse().map(t => `
                <div class="transaction-item" style="background: #d1fae5; border-left: 4px solid #059669;">
                    <div class="transaction-info">
                        <div class="transaction-amount" style="color: #065f46;">${formatCurrency(t.amount)}</div>
                        <div class="transaction-details">${new Date(t.timestamp).toLocaleString('id-ID')} - ${t.note || 'Tanpa catatan'}</div>
                        <div class="transaction-details" style="font-size: 11px; color: #059669;">Transfer: ${new Date(t.transferDate).toLocaleDateString('id-ID')}</div>
                    </div>
                    <div class="transaction-status" style="background: #d1fae5; color: #065f46; border: 1px solid #059669;">
                        ‚úÖ Sudah Transfer
                    </div>
                </div>
            `).join('');
        }

        function showChart(period) {
            document.querySelectorAll('.chart-section .btn-small').forEach(btn => {
                if (!btn.onclick.toString().includes('refreshFromSheets')) {
                    btn.style.background = '#6b7280';
                    btn.style.color = 'white';
                }
            });
            
            event.target.style.background = '#2563eb';
            
            const chartMessages = {
                daily: 'GRAFIK TREN PEMASUKAN HARIAN',
                weekly: 'GRAFIK TREN PEMASUKAN MINGGUAN', 
                monthly: 'GRAFIK TREN PEMASUKAN BULANAN',
                custom: 'GRAFIK PERIODE CUSTOM'
            };
            
            document.querySelector('.chart-placeholder').innerHTML = `
                üìä ${chartMessages[period]}<br>
                <small>(Data realtime dari Google Sheets)</small>
            `;
        }

        async function refreshFromSheets() {
            try {
                await dataStore.testConnection();
                await updateOwnerStats();
                showAlert('üîÑ Data berhasil direfresh dari Google Sheets!', 'info', 2000);
            } catch (error) {
                showAlert('‚ùå Gagal refresh dari Google Sheets', 'danger');
            }
        }

        // PWA Installation - ORIGINAL
        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                const swData = `
                    const CACHE_NAME = 'londripedia-cash-online-v1';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swData], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(() => console.log('SW registered'))
                    .catch(() => console.log('SW registration failed'));
            });
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            setTimeout(() => {
                if (!window.matchMedia('(display-mode: standalone)').matches) {
                    document.getElementById('installPrompt').classList.remove('hidden');
                }
            }, 3000);
        });

        function closeInstallPrompt() {
            document.getElementById('installPrompt').classList.add('hidden');
        }

        // Initialize app - ORIGINAL + Online Status
        document.addEventListener('DOMContentLoaded', function() {
            // Check storage availability and update status
            if (!dataStore.storageAvailable) {
                document.getElementById('storageStatus').innerHTML = '‚ö†Ô∏è Mode sementara - data tidak akan tersimpan';
                document.getElementById('storageStatus').style.color = '#dc2626';
            }

            // Monitor online/offline status
            window.addEventListener('online', () => {
                dataStore.testConnection();
            });
            
            window.addEventListener('offline', () => {
                updateOnlineStatus(false);
            });

            // Set up enter key handling for login
            document.getElementById('accessCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });

            // Set up enter key handling for SPV form
            document.getElementById('spvAmount').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('spvNote').focus();
                }
            });

            document.getElementById('spvNote').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitTransaction();
                }
            });

            // Currency formatting for amount input
            document.getElementById('spvAmount').addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/g, '');
                if (value) {
                    const formatted = parseInt(value).toLocaleString('id-ID');
                    e.target.value = formatted;
                }
            });

            // Auto-focus on access code
            document.getElementById('accessCode').focus();

            console.log('üè™ LondriPediaCash Online ready!');
            console.log('‚òÅÔ∏è Google Sheets integration enabled');
        });
    </script>
</body>
</html>